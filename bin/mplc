#!/usr/bin/env bash
# Companion script for mpl
shopt -s globstar

# Print error and exit with err code
err() { printf "%s\n" "$2"; exit $1; }

if [ -d /tmp/mpl* ]; then
	# Find temp dir
	tmpd="$(find /tmp -type d -name 'mpl*')"
	# Get id
	mplid="$(cat $tmpd/pid)"
	# Get track
	mptrack="$tmpd/track"
else
	err 1 'mpl is not running.'
fi

case "$1" in
	[iI]*) # Info
		echo "$mplid"
		cat "$mptrack"
		;;
	[tT]*) # Track name
		if [ -f "$mptrack" ]; then
			cat "$mptrack"
		fi
		;;
	[sS][kK]*) # Skip track
		# TODO: Only terminate mpv session associated with mpl
		killall mpv
		# Send signal to bar
		pkill -RTMIN+14 waybar
		;;
	[sS][tT]*) # Stop player
		printf "%s\n" 'stopping mpl...'
		killall mpv
		kill "$mplid"
		pkill -RTMIN+14 waybr
		;;
	[cC]*) # Clean
		rm -rv "$tmpd"
		;;
	*)
		err 2 "usage: $(basename $0) [command]"
		;;
esac
